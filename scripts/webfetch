#!/usr/bin/env bun

const TurndownService = require('turndown');

const MAX_RESPONSE_SIZE = 5 * 1024 * 1024;
const DEFAULT_TIMEOUT = 30 * 1000;
const MAX_TIMEOUT = 120 * 1000;

const turndownService = new TurndownService({
  headingStyle: "atx",
  codeBlockStyle: "fenced",
});

turndownService.addRule("removeScripts", {
  filter: ["script", "style", "noscript", "iframe", "object", "embed"],
  replacement: () => "",
});

async function webfetch(url, timeout) {
  if (!url.startsWith("http://") && !url.startsWith("https://")) {
    throw new Error("URL must start with http:// or https://");
  }

  const timeoutMs = Math.min((timeout ?? DEFAULT_TIMEOUT / 1000) * 1000, MAX_TIMEOUT);
  const controller = new AbortController();
  const timeoutId = setTimeout(() => controller.abort(), timeoutMs);

  const response = await fetch(url, {
    signal: controller.signal,
    headers: {
      "User-Agent":
        "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/143.0.0.0 Safari/537.36",
      Accept: "text/markdown;q=1.0, text/x-markdown;q=0.9, text/plain;q=0.8, text/html;q=0.7, */*;q=0.1",
      "Accept-Language": "en-US,en;q=0.9",
    },
  });

  clearTimeout(timeoutId);

  if (!response.ok) {
    throw new Error(`HTTP error! status: ${response.status}`);
  }

  const contentLength = response.headers.get("content-length");
  if (contentLength && parseInt(contentLength) > MAX_RESPONSE_SIZE) {
    throw new Error("Response too large (exceeds 5MB limit)");
  }

  const arrayBuffer = await response.arrayBuffer();
  if (arrayBuffer.byteLength > MAX_RESPONSE_SIZE) {
    throw new Error("Response too large (exceeds 5MB limit)");
  }

  const contentType = response.headers.get("content-type") || "application/octet-stream";
  const decoder = new TextDecoder();
  const text = decoder.decode(arrayBuffer);

  let title = url;
  const titleMatch = text.match(/<title[^>]*>([^<]+)<\/title>/i);
  if (titleMatch) {
    title = titleMatch[1].trim();
  }

  const result = turndownService.turndown(text);

  const metadata = `---
title: "${title.replace(/"/g, '\\"')}"
source: ${url}
fetched_at: ${new Date().toISOString()}
---

`;

  console.log(metadata + result);
}

const args = process.argv.slice(2);
const url = args[0];
const timeout = args[1] ? parseInt(args[1]) : undefined;

if (!url) {
  console.error("Usage: webfetch <url> [timeout]");
  console.error("  url: The URL to fetch content from (required)");
  console.error("  timeout: timeout in seconds (default: 30, max: 120)");
  process.exit(1);
}

webfetch(url, timeout).catch((error) => {
  console.error("Error:", error.message);
  process.exit(1);
});
